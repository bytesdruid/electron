import{ba as P}from"./index.3c0e8881.js";function y(n,t){for(var s=0;s<t.length;s++){const r=t[s];if(typeof r!="string"&&!Array.isArray(r)){for(const e in r)if(e!=="default"&&!(e in n)){const i=Object.getOwnPropertyDescriptor(r,e);i&&Object.defineProperty(n,e,i.get?i:{enumerable:!0,get:()=>r[e]})}}}return Object.freeze(Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}))}var d={exports:{}};const b={WINDOW_NOT_LOADED:"Window not loaded",WINDOW_IS_OPENED:"Windows is opened",WINDOW_NOT_OPENED:"Can not open popup window",INVALID_WINDOW:"Invalid window"};class x extends Error{constructor(t,s,r){super(t),this.code=s,this.data=r}}var m={ERRORS:b,SignTxnsError:x};const{WINDOW_NOT_OPENED:f}=m,W={width:400,height:600};function A(n,t=W){let{name:s="",width:r,height:e,top:i=0,left:o=0}=t;r&&(window.outerWidth?o=Math.round((window.outerWidth-r)/2)+window.screenX:window.screen.width&&(o=Math.round((window.screen.width-r)/2))),e&&(window.outerHeight?i=Math.round((window.outerHeight-e)/2)+window.screenY:window.screen.height&&(i=Math.round((window.screen.height-e)/2))),r&&e&&(t={top:i,left:o,width:r,height:e,status:1,toolbar:0,menubar:0,resizable:1,scrollbars:1});const a=Object.keys(t).map(u=>{const p=t[u];if(p!=null&&typeof p.toString=="function")return`${u}=${p.toString()}`}).filter(Boolean).join(",");let c;try{c=window.open(n,s,a)}catch(u){throw new Error(`${f} - ${u.stack||u.message}`)}if(!c||window.closed)throw new Error(`${f} - blocked`);return c}var L={openPopup:A};function N(n=200){return new Promise(t=>setTimeout(t,n))}function _(n){if(n.constructor===Uint8Array)return Buffer.from(n).toString("base64");if(typeof n=="string")return n;const t=Object.assign({},n);if(t.note&&t.note.constructor===Uint8Array&&(t.note=Buffer.from(t.note).toString("base64")),t.assetMetadataHash&&t.assetMetadataHash.constructor===Uint8Array&&(t.assetMetadataHash=Buffer.from(t.assetMetadataHash).toString("base64")),t.group&&t.group.constructor===Uint8Array&&(t.group=Buffer.from(t.group).toString("base64")),t.type==="appl"&&t.appApprovalProgram&&t.appApprovalProgram.constructor===Uint8Array&&(t.appApprovalProgram=Buffer.from(t.appApprovalProgram).toString("base64")),t.type==="appl"&&t.appClearProgram&&t.appClearProgram.constructor===Uint8Array&&(t.appClearProgram=Buffer.from(t.appClearProgram).toString("base64")),t.type==="appl"&&t.appArgs&&t.appArgs.length>0)for(let s=0;s<t.appArgs.length;s++)t.appArgs[s].constructor===Uint8Array&&(t.appArgs[s]=Buffer.from(t.appArgs[s]).toString("base64"));return t}var T={sleep:N,prepareTxn:_},S={exports:{}};class B{constructor(t,s){this.channelName=t,this.onMessage=s,this._installListener(),this._requests=new Map,this._nextId=0,this._defaultTimeout=4e3}_installListener(){const t=this;this._listener=function(s){if(!s.data||typeof s.data!="string")return;let r;try{if(r=JSON.parse(s.data),!r.channel||r.channel!==t.channelName||typeof r.message!="object")return}catch{return}if(typeof r.replyId<"u"){if(typeof r.replyId!="number"||r.replyId%1!==0)return;const e=t._requests.get(r.replyId);if(e){if(s.origin!==e.targetOrigin)return;clearTimeout(e.timeout),t._requests.delete(r.replyId),e.resolve(r.message)}}else{if(typeof r.id!="number"||r.id%1!==0||!t.onMessage)return;const e=t.channelName,i=r.id,o=s.origin,a=function(c){const u={channel:e,replyId:i,message:c};s.source.postMessage(JSON.stringify(u),o)};t.onMessage(r.message,s.origin,s.source,a,t)}},window.addEventListener("message",this._listener)}sendMessage(t,s,r,e){let i;try{i=new URL(r).origin}catch{throw new Error("Invalid origin URL")}const o={channel:this.channelName,id:this.getNextId(),message:s};if(e&&e.waitForReply){const a=this;return new Promise(function(c,u){const p=setTimeout(function(){a._requests.get(o.id)&&(a._requests.delete(o.id),u(new Error("Timeout expired for the message response")))},e&&e.timeout?e.timeout:a._defaultTimeout);a._requests.set(o.id,{timeout:p,resolve:c,targetOrigin:i}),t.postMessage(JSON.stringify(o),i)})}t.postMessage(JSON.stringify(o),i)}close(){window.removeEventListener("message",this._listener),this._listener=null,delete this._requests}getNextId(){return this._nextId+=1,this._nextId}}var E=B;(function(n){n.exports=E})(S);const M=S.exports,O="wallet-bridge-communication-channel";class I{constructor(t){const s=this;this.options={waitForReply:!0,timeout:250},this.listenerCallback=t,this.bridge=new M(O,function(r,e,i,o){s.listenerCallback&&s.listenerCallback(r,i)})}sendMessage(t,s,r,e){return this.bridge.sendMessage(t,s,r,e||this.options)}setNewListener(t){this.listenerCallback=t}close(){this.bridge.close()}}var C=I;const{openPopup:l}=L,{sleep:D,prepareTxn:w}=T,{Errors:g,SignTxnsError:U}=m,v=C;let h=null;class q{constructor(t){h||(h=new v),this.bridge=h,this.timeout=t&&t.timeout?t.timeout:16e5,this.url=t&&t.bridgeUrl?t.bridgeUrl:"https://wallet.myalgo.com/bridge",this.url.endsWith("/")&&(this.url=this.url.slice(0,-1)),this.currentConnectPopup=null,this.currentSigntxPopup=null,this.currentSignLogicSigPopup=null,this.currentTealSignPopup=null,this.currentSignBytesPopup=null,this.options={waitForReply:!0,timeout:this.timeout},this.disableLedgerNano=t&&t.disableLedgerNano?t.disableLedgerNano:!1}async connect(t={shouldSelectOneAccount:!1,openManager:!1}){this.currentConnectPopup&&(this.currentConnectPopup.closed?this.currentConnectPopup=null:this.focusWindow(this.currentConnectPopup));try{this.currentConnectPopup=l(this.url+"/connect.html"),await this.waitForWindowToLoad(this.currentConnectPopup);const s=await this.bridge.sendMessage(this.currentConnectPopup,{method:"unlock",params:Object.assign(t,{disableLedgerNano:this.disableLedgerNano})},this.url,this.options);if(this.closeWindow(this.currentConnectPopup),this.currentConnectPopup=null,s.status==="error")throw new Error(s.message);return s.data.accounts}catch(s){throw this.closeWindow(this.currentConnectPopup),this.currentConnectPopup=null,s}}async signTransaction(t,s){let r;this.currentSigntxPopup&&(this.currentSigntxPopup.closed?this.currentSigntxPopup=null:this.focusWindow(this.currentSigntxPopup)),Array.isArray(t)?r=Array.from(t).map(e=>w(e)):r=w(t);try{this.currentSigntxPopup=l(this.url+"/signtx.html"),await this.waitForWindowToLoad(this.currentSigntxPopup);const e=await this.bridge.sendMessage(this.currentSigntxPopup,{method:"transaction",params:{txn:r,settings:{disableLedgerNano:this.disableLedgerNano},options:s}},this.url,this.options);if(this.closeWindow(this.currentSigntxPopup),this.currentSigntxPopup=null,e.status==="error")throw new Error(e.message);if(Array.isArray(e.data)){const i=[];for(const o of e.data)o.blob=new Uint8Array(Buffer.from(o.blob,"hex")),i.push(o);return i}return e.data.blob=new Uint8Array(Buffer.from(e.data.blob,"hex")),e.data}catch(e){throw this.closeWindow(this.currentSigntxPopup),this.currentSigntxPopup=null,e}}async signTxns(t,s){this.currentSigntxPopup&&(this.currentSigntxPopup.closed?this.currentSigntxPopup=null:this.focusWindow(this.currentSigntxPopup));try{let r=t;Array.isArray(t)||(r=[t]),this.currentSigntxPopup=l(this.url+"/signtx.html"),await this.waitForWindowToLoad(this.currentSigntxPopup);const e=await this.bridge.sendMessage(this.currentSigntxPopup,{method:"signTxns",params:{txns:r,settings:{disableLedgerNano:this.disableLedgerNano},opts:s}},this.url,this.options);if(this.closeWindow(this.currentSigntxPopup),this.currentSigntxPopup=null,e.status==="error")throw new U(e.message,e.code,e.data);return e.data.map(i=>i?Buffer.from(i.blob,"hex").toString("base64"):null)}catch(r){throw this.closeWindow(this.currentSigntxPopup),this.currentSigntxPopup=null,r}}async signLogicSig(t,s){this.currentSignLogicSigPopup&&(this.currentSignLogicSigPopup.closed?this.currentSignLogicSigPopup=null:this.focusWindow(this.currentSignLogicSigPopup));try{this.currentSignLogicSigPopup=l(this.url+"/logicsigtx.html"),await this.waitForWindowToLoad(this.currentSignLogicSigPopup);let r=t;t.constructor===Uint8Array&&(r=Buffer.from(t).toString("base64"));const e=await this.bridge.sendMessage(this.currentSignLogicSigPopup,{method:"logicsig",params:{logic:r,address:s}},this.url,this.options);if(this.closeWindow(this.currentSignLogicSigPopup),this.currentSignLogicSigPopup=null,e.status==="error")throw new Error(e.message);return new Uint8Array(Buffer.from(e.data.signedTeal,"base64"))}catch(r){throw this.closeWindow(this.currentSignLogicSigPopup),this.currentSignLogicSigPopup=null,r}}async tealSign(t,s,r){this.currentTealSignPopup&&(this.currentTealSignPopup.closed?this.currentTealSignPopup=null:this.focusWindow(this.currentTealSignPopup));try{this.currentTealSignPopup=l(this.url+"/tealsign.html"),await this.waitForWindowToLoad(this.currentTealSignPopup);let e=t;t.constructor===Uint8Array&&(e=Buffer.from(t).toString("base64"));const i=await this.bridge.sendMessage(this.currentTealSignPopup,{method:"tealsign",params:{data:e,contractAddress:s,address:r}},this.url,this.options);if(this.closeWindow(this.currentTealSignPopup),this.currentTealSignPopup=null,i.status==="error")throw new Error(i.message);return new Uint8Array(Buffer.from(i.data.signature,"base64"))}catch(e){throw this.closeWindow(this.currentTealSignPopup),this.currentTealSignPopup=null,e}}async signBytes(t,s){this.currentSignBytesPopup&&(this.currentSignBytesPopup.closed?this.currentSignBytesPopup=null:this.focusWindow(this.currentSignBytesPopup));try{this.currentSignBytesPopup=l(this.url+"/signbytes.html"),await this.waitForWindowToLoad(this.currentSignBytesPopup);let r=Buffer.from(t).toString("base64");const e=await this.bridge.sendMessage(this.currentSignBytesPopup,{method:"signbytes",params:{data:r,address:s}},this.url,this.options);if(this.closeWindow(this.currentSignBytesPopup),this.currentSignBytesPopup=null,e.status==="error")throw new Error(e.message);return new Uint8Array(Buffer.from(e.data.signature,"base64"))}catch(r){throw this.closeWindow(this.currentSignBytesPopup),this.currentSignBytesPopup=null,r}}async waitForWindowToLoad(t,s=30){for(let r=0;r<s&&(await D(300),!!t);r++)try{if((await h.sendMessage(t,{method:"status"},this.url)).status=="success")return}catch{}throw new Error(g.WINDOW_NOT_LOADED)}closeWindow(t){t&&!t.closed&&t.close&&t.close()}focusWindow(t){throw t&&t.focus?(t.focus(),new Error(g.WINDOW_IS_OPENED)):new Error(g.INVALID_WINDOW)}}var $=q;(function(n){n.exports=$})(d);const j=P(d.exports),R=y({__proto__:null,default:j},[d.exports]);export{R as i};
